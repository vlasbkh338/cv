function e({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:l=n||o,scope:s={},meta:f={},family:i={type:'regular'}}={}){let c=be(a),u=be(i.links),p=be(i.owners),d=[],m={};for(let t=0;t<e.length;t++){let r=e[t];r&&(d.push(r),ve(r,m))}let h={id:B(),seq:d,next:be(l),meta:f,scope:s,family:{type:i.type||'crosslink',links:u,owners:p},reg:m};for(let e=0;e<u.length;e++)ce(u[e]).push(h);for(let e=0;e<p.length;e++)ue(p[e]).push(h);for(let e=0;e<c.length;e++)c[e].next.push(h);return h}function t(e,t="combine"){let r=t+'(',a='',n=0;for(let t in e){let o=e[t];if(null!=o&&(r+=a,r+=D(o)?o.compositeName.fullName:o.toString()),n+=1,25===n)break;a=', '}return r+=')',r}function r(e,t){let r=a(t,ye(e));if(e.shortName=t,!e.compositeName)return void(e.compositeName=r);let n=e.compositeName;n.path=r.path,n.shortName=r.shortName,n.fullName=r.fullName}function a(e,t){let r,a,n,o=e;return t?(n=t.compositeName,0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)):(r=0===e.length?[]:[e],a=e),{shortName:o,fullName:a,path:r}}function n(e,t){e.forEach(t)}function o(e,t){Ve={parent:Ve,value:e,template:ie(e).meta.template||Ve&&Ve.template};try{return t()}finally{Ve=ye(Ve)}}function l(t,r){let a=(e,...t)=>Fe?((e,t,r,a)=>{let n=Fe,o=null;if(t)for(o=Fe;o&&o.template!==t;)o=ye(o);_e(o);let l=e.create(r,a);return _e(n),l})(a,n,e,t):a.create(e,t);a.graphite=e({meta:nt('event',a,r,t)}),a.create=e=>{let t=Oe?Oe.find(a):a;return Ee(t,e),e},a.watch=J(et,a),a.map=e=>{let t,r;T(e)&&(t=e,r=e.name,e=e.fn);let n=l(Re(a,r),t);return lt(a,n,'map',e),n},a.filter=e=>st(a,'filter',e.fn?e:e.fn,[ee({fn:fe})]),a.filterMap=e=>st(a,'filterMap',e,[Z({fn:fe}),Y.defined()]),a.prepend=e=>{let t=l('* → '+a.shortName,{parent:ye(a)}),r=Xe();return r&&ie(t).seq.push(r.upward),lt(t,a,'prepend',e),at(a,t),t};let n=Xe();return n&&(ie(a).meta.nativeTemplate=n),Qe(a)}function s(t,r){function a(e,t){c.off(e),ge(c).set(e,Le(ft(e,c,'on',1,t)))}let n=ne(t),o=ne(t),l=ot('updates'),f=Xe();n.after=[{type:'copy',to:o}],f&&f.plain.push(n,o);let i=n.id,c={subscribers:new Map,updates:l,defaultState:t,stateRef:n,getState(){let e,t=n;if(Fe){let t=Fe;for(;t&&!t.reg[i];)t=ye(t);t&&(e=t)}return!e&&Oe&&Oe.reg[i]&&(e=Oe),e&&(t=e.reg[i]),oe(t)},setState(e){let t;Oe&&(t=Oe.nodeMap[ie(c).id]),t||(t=c),Ee({target:t,params:e,defer:1})},reset(...e){for(let t of e)c.on(t,()=>c.defaultState);return c},on(e,t){if(Array.isArray(e))for(let r of e)a(r,t);else a(e,t);return c},off(e){let t=ge(c).get(e);return t&&(t(),ge(c).delete(e)),c},map(e,t){let r,a,o;T(e)&&(r=e,a=e.name,t=e.firstState,e=e.fn);let l=c.getState(),f=Xe();f?o=null:void 0!==l&&(o=e(l,t));let i=s(o,{name:Re(c,a),config:r,strict:0}),u=ft(c,i,'map',0,e);return pe(i).before=[{type:'map',fn:e,from:n}],f&&(Ge(f.plain,n)||Ge(u.seq,f.loader)||u.seq.unshift(f.loader)),i},watch(e,t){if(!t||!D(e)){let t=et(c,e),r=Xe();return r?r.watch.push({of:n,fn:e}):e(c.getState()),t}return W(t)||R('second argument should be a function'),e.watch(e=>t(c.getState(),e))}};return c.graphite=e({scope:{state:n},node:[Y.defined(),re({store:n}),Y.changed({store:o}),re({store:o})],child:l,meta:nt('store',c,r)}),rt&&void 0===t&&R("current state can't be undefined, use null instead"),f&&(ie(c).meta.nativeTemplate=f),ke(c,[l]),Qe(c)}function f(...e){let t,r,a;Te(e[0],(t,r)=>{a=t,e=r});let n,o,l=e[e.length-1];if(W(l)?(r=e.slice(0,-1),t=l):r=e,1===r.length){let e=r[0];I(e)||(n=e,o=1)}return o||(n=r,t&&(t=ct(t))),T(n)||R('shape should be an object'),ut(Array.isArray(n),n,a,t)}function i(){let e={};return e.req=new Promise((t,r)=>{e.rs=t,e.rj=r}),e.req.catch(()=>{}),e}function c(t,r){let a=l(t,r),n=a.defaultConfig.handler||(()=>R("no handler used in "+a.getType()));ie(a).meta.onCopy=['runner'],ie(a).meta.unit=a.kind='effect',a.use=e=>(W(e)||R('.use argument should be a function'),n=e,a);let o=a.finally=ot('finally'),f=a.done=o.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),c=a.fail=o.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),u=a.doneData=f.map({named:'doneData',fn:({result:e})=>e}),p=a.failData=c.map({named:'failData',fn:({error:e})=>e}),d=e({scope:{getHandler:a.use.getCurrent=()=>n,finally:o},node:[te({fn({params:e,req:t},{finally:r,getHandler:a},{page:n,forkPage:o}){let l,s=pt({params:e,req:t,ok:1,anyway:r,page:n,forkPage:o}),f=pt({params:e,req:t,ok:0,anyway:r,page:n,forkPage:o});try{l=a()(e)}catch(e){return void f(e)}T(l)&&W(l.then)?l.then(s,f):s(l)}})],meta:{op:'fx',fx:'runner',onCopy:['finally']}});ie(a).scope.runner=d,ie(a).seq.push(Z({fn:(e,t,r)=>ye(r)?{params:e,req:{rs(e){},rj(e){}}}:e}),te({fn:(e,{runner:t},{forkPage:r})=>(Ee({target:t,params:e,defer:1,forkPage:r}),e.params)})),a.create=e=>{let t=i(),r={params:e,req:t};if(Oe){let e=Oe;t.req.finally(()=>{Ie(e)}),Ee(Oe.find(a),r)}else Ee(a,r);return t.req};let m=a.inFlight=s(0,{named:'inFlight'}).on(a,e=>e+1).on(o,e=>e-1),h=a.pending=m.map({fn:e=>e>0,named:'pending'});return ke(a,[o,f,c,u,p,h,m,d]),a}function u(e){let t;Te(e,(r,a)=>{t=r,e=a});let{source:r,effect:a,mapParams:n}=e;r||n||R('either `mapParams` or `source` should be defined'),n||(n=(e,t)=>t);let o,l=c(e,t),{runner:s}=ie(l).scope,i=({params:e,req:t},{finally:r,effect:a},{a:o,page:l,forkPage:s})=>{let f,i=pt({params:e,req:t,ok:0,anyway:r,page:l,forkPage:s});try{f=n(e,o)}catch(e){return i(e)}Ee({target:a,params:{params:f,req:{rs:pt({params:e,req:t,ok:1,anyway:r,page:l,forkPage:s}),rj:i}},page:l,defer:1})};if(r){let e;I(r)?e=r:(e=f(r),ke(l,[e]));let t=X({from:'store',store:pe(e),to:'a'});o=[te({fn:e=>e}),t,Z({fn:i})],ve(t,s.reg)}else o=[te({fn:i})];return s.scope.effect=a,s.meta.onCopy.push('effect'),s.seq.splice(0,1,...o),at(a,l,'effect'),l}function p(...e){let[[t,r],a]=We(e),n={};return He(r,(e,r)=>{let o=n[r]=l(r,{parent:ye(t),config:a});t.on(o,e),at(t,o)}),n}function d(t,r){let a=new Set,n=new Set,o=new Set,f=new Set,i=e({family:{type:'domain'}}),u={history:{domains:a,stores:n,effects:o,events:f},graphite:i};i.meta=nt('domain',u,r,t);let[p,m,h,g]=['onEvent','onEffect','onStore','onDomain'].map(ot);u.hooks={event:p,effect:m,store:h,domain:g},u.onCreateEvent=mt(p,f,u),u.onCreateEffect=mt(m,o,u),u.onCreateStore=mt(h,n,u),u.onCreateDomain=mt(g,a,u),u.createEvent=u.event=(e,t)=>p(l(e,{parent:u,config:t})),u.createEffect=u.effect=(e,t)=>m(c(e,{parent:u,config:t})),u.createDomain=u.domain=(e,t)=>d({name:e,parent:u,config:t}),u.createStore=u.store=(e,t)=>h(s(e,{parent:u,config:t})),Qe(u);let y=ye(u);return y&&(He(u.hooks,(e,t)=>{Ze({from:e,to:y.hooks[t]})}),y.hooks.domain(u)),u}function m(e){H(e);let t=O in e?e[O]():e;t.subscribe||R('expect observable to have .subscribe');let r=l(),a=K(Ke,r,void 0);return t.subscribe({next:r,error:a,complete:a}),r}function h(...t){let r,a,n,o,[[i,c,u],p]=We(t);void 0===c&&'source'in i&&('clock'in i&&null==i.clock&&R('config.clock should be defined'),c=i.clock,u=i.fn,o=i.greedy,r=i.target,a=i.name,n=i.sid,i=i.source),D(i)||(i=f(i)),void 0===c&&(c=i),a=p||a||i.shortName;let d=Xe(),m=!!r;r||(I(i)&&I(c)?r=s(u?u(oe(pe(i)),oe(pe(c))):oe(pe(i)),{name:a,sid:n}):(r=l(a),d&&ie(r).seq.push(d.loader)));let h=m&&D(r)&&ie(r).meta.nativeTemplate;if(I(i)){let e=pe(i);ke(i,[Ye(c,r,{scope:{fn:u,targetTemplate:h},node:[d&&d.loader,!o&&V({priority:'sampler'}),X({store:e,to:u?'a':'stack'}),u&&Z({fn:se}),d&&m&&d.upward],meta:{op:'sample',sample:'store'}})]),d&&(Ge(d.plain,e)||Ge(d.closure,e)||d.closure.push(e))}else{let t=ne(0),a=ne(),n=ne();d&&d.plain.push(t,a,n),Qe(e({parent:i,node:[re({store:a}),X({from:'value',store:1,target:t})],family:{owners:[i,r,c],links:r},meta:{op:'sample',sample:'source'}})),ke(i,[Ye(c,r,{scope:{fn:u,targetTemplate:h},node:[d&&d.loader,re({store:n}),X({store:t}),ee({fn:e=>e}),!o&&V({priority:'sampler'}),X({store:a}),X({store:n,to:'a'}),u&&Z({fn:le}),d&&m&&d.upward],meta:{op:'sample',sample:'clock'}})])}return r}function g(...t){let r={op:'guard'},a='guard',[[n,o],s]=We(t);s&&(r.config=s,s.name&&(a=s.name)),o||(o=n,n=o.source);let{filter:i,greedy:c,name:u=a}=o,p=o.target||l(u,r.config);return D(n)||(n=f(n)),D(i)?h({source:i,clock:n,target:Qe(e({node:[ee({fn:({guard:e})=>e}),Z({fn:({data:e})=>e})],child:p,meta:r,family:{owners:[n,i,p],links:p}})),fn:(e,t)=>({guard:e,data:t}),greedy:c,name:u}):(W(i)||R('`filter` should be function or unit'),Ye(n,p,{scope:{fn:i},node:[ee({fn:fe})],meta:r})),p}function y(e){let r=l(t(e,'merge'));return Ze({from:e,to:r,meta:{op:'merge'}}),r}function k(e,t,r){if(I(e))return e;if(D(e)){let a,n=ye(e);return _(e)&&(a=s(t,{parent:n,name:e.shortName,ɔ:r}).on(e,(e,t)=>t)),E(e)&&(a=s(t,{parent:n,name:e.shortName,ɔ:r}).on(e.done,(e,{result:t})=>t)),n&&n.hooks.store(a),a}let a=Array.isArray(e)?[]:{};return He(e,(e,t)=>{a[t]=I(e)?e:s(e,{name:t})}),a}function b(...e){let t,[[r,a],n]=We(e),o=!a;o&&(t=r.cases,a=r.match,r=r.source);let l={},s=I(r)?r.updates:r;if(He(a,(e,t)=>{l[t]=s.filter({fn:e,config:n}),s=s.filter({fn:t=>!e(t),config:n})}),l.__=s,!o)return l;He(l,(e,r)=>{t[r]&&Ze({from:e,to:t[r]})})}function v(e,{values:t}){M(e)||R('first argument of hydrate should be domain'),T(t)||R('values property should be an object');let{storeWatches:r,storeWatchesRefs:a}=(({flatGraphUnits:e,values:t,collectWatches:r})=>{let a=[],o=[],l={},s=new Set,f=Object.getOwnPropertyNames(t);for(let n of e){let{reg:e}=n,{op:i,unit:c,sid:u}=n.meta;if('store'===c&&u&&Ge(f,u)){let{state:e}=n.scope;e.current=t[u],s.add(e)}if(r&&'watch'===i){let e=n.family.owners[0];'store'===e.meta.unit&&(a.push(n),o.push(e.scope.state))}for(let t in e)l[t]=e[t]}return n(N(w(l)),e=>{(e=>{let t=0;if(e.before&&!s.has(e))for(let r of e.before)switch(r.type){case'map':e.current=r.fn(r.from.current);break;case'field':{let a=r.from;t||(t=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[r.field]=a.current;break}}if(!e.after)return;let r=e.current;for(let t of e.after){let e=t.to;switch(t.type){case'copy':e.current=r;break;case'map':e.current=t.fn(r)}}})(l[e])}),{storeWatches:a,storeWatchesRefs:o}})({flatGraphUnits:A(e),values:x(t),collectWatches:1});Ee({target:r,params:a.map(({current:e})=>e)})}function w(e){let t=Object.values(e),r={};for(let{id:e}of t)r[e]=[];for(let{id:e,before:a,after:o}of t)a&&n(a,t=>{r[t.from.id].push(e)}),o&&n(o,t=>{r[e].push(t.to.id)});return r}function S({clones:e,getState:t,cloneOf:r},{ignore:a=[],onlyChanges:n}={}){let o={};if(n){a=[...a];for(let e of r.history.stores)t(e)===e.defaultState&&a.push(e)}for(let{meta:t,scope:r,reg:a}of e){if('store'!==t.unit)continue;let{sid:e}=t;e&&(o[e]=a[r.state.id].current)}for(let{sid:e}of a)e&&delete o[e];return o}function q(e){Oe||R('scopeBind cannot be called outside of forked .watch');let t=Oe.find(e),r=Oe;return e=>{Ee({target:t,params:e,forkPage:r})}}function x(e){if(e instanceof Map){let t={};for(let[r,a]of e)t[r.sid]=a;return t}return e}function P(t,{values:r,handlers:a}={}){M(t)||R('first argument of fork should be domain');let o=!!r;r=x(r||{});let l=(t=>{function r(e){e=ie(e);let t=a.indexOf(e);return-1===t&&R('unit not found in forked scope'),i[t]}let a=A(t),o=new Map,l=Z({fn:(e,t,r)=>(Ie(r.forkPage),e)}),s=e({scope:{defers:[],inFlight:0,fxID:0},node:[Z({fn(e,t,r){r.parent?'finally'===r.parent.node.meta.named?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1}}),V({priority:'sampler'}),te({fn(e,t){let{inFlight:r,defers:a,fxID:o}=t;r>0||0===a.length||Promise.resolve().then(()=>{t.fxID===o&&n(a.splice(0,a.length),e=>{Ie(e.parentFork),e.rs(e.value)})})}})],meta:{unit:'forkInFlightCounter'}}),f={},i=a.map(t=>{let{seq:r,next:a,meta:n,scope:o,family:l}=t,s=e({node:r.map(e=>({id:e.id,type:e.type,data:Object.assign({},e.data),hasRef:e.hasRef})),child:[...a],meta:Object.assign({forkOf:t},n),scope:Object.assign({},o)});return s.family={type:l.type,links:[...l.links],owners:[...l.owners]},f[t.id]=s,s}),c={};return n(i,e=>{let{reg:t,scope:a,meta:{onCopy:n,op:f,unit:i}}=e;for(let e in t){let r=t[e],a=o.get(r);a||(a={id:r.id,current:r.current},o.set(r,a)),c[e]=t[e]=a}if(n)for(let e=0;e<n.length;e++)a[n[e]]=r(a[n[e]]);switch(C(e,(e,t,a)=>{a[t]=r(e)}),f||i){case'store':e.meta.wrapped=(e=>({kind:'store',getState:()=>e.reg[e.scope.state.id].current,updates:{watch:J(et,e)},graphite:e,family:e.family}))(e);break;case'event':e.seq.unshift(l);break;case'effect':e.next.push(s),e.seq.unshift(l);break;case'fx':a.finally.next.push(s),e.seq.unshift(l);break;case'watch':e.seq.unshift(l)}}),{cloneOf:t,nodeMap:f,clones:i,find:r,reg:c,getState:e=>r(e).meta.wrapped.getState(),graphite:e({family:{type:'domain',links:[s,...i]},meta:{unit:'fork'},scope:{forkInFlightCounter:s}})}})(t);if(o&&(()=>{let e=A(t),a={},o={},s=new Set,f=new Set,i=Object.getOwnPropertyNames(r);for(let{reg:t,meta:r}of e){let{nativeTemplate:e}=r;for(let r in t)a[r]=t[r],e&&f.add(r)}for(let e of l.clones){let{reg:t}=e,{unit:a,sid:n}=e.meta;if('store'===a&&n&&Ge(i,n)){let{state:a}=e.scope;t[a.id].current=r[n],s.add(a)}for(let e in t)o[e]=t[e]}n(N(w(a),f),e=>{((e,t)=>{let r=0;if(t&&t.before&&!s.has(e))for(let a of t.before)switch(a.type){case'map':e.current=a.fn(o[a.from.id].current);break;case'field':{let t=o[a.from.id];r||(r=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[a.field]=t.current;break}}if(!t||!t.after)return;let a=e.current;for(let e of t.after){let t=o[e.to.id];switch(e.type){case'copy':t.current=a;break;case'map':t.current=e.fn(a)}}})(o[e],a[e])})})(),a){a=x(a);let e=Object.keys(a);for(let{scope:t,meta:r}of l.clones)r.sid&&Ge(e,r.sid)&&(t.runner.scope.getHandler=()=>a[r.sid])}return l}function N(e,t){function r(e){s[e]=1;let t=a[e];for(let e=0;e<t.length;e++){let a=t[e];s[a]||l[a]||r(a)}s[e]=0,l[e]=1,o.push(e)}let a={};for(let t in e)a[t]=[...new Set(e[t])];let o=[],l={},s={};for(let e in a)l[e]||s[e]||r(e);if(o.reverse(),t&&t.size>0){let e,r=[],l=[...t];for(;e=l.shift();)r.push(e),n(a[e],e=>{Ge(r,e)||Ge(l,e)||l.push(e)});n(r,e=>{Ue(o,e)})}return o}function j(e,{scope:t,params:r}){if(!D(e))return Promise.reject(Error('first argument should be unit'));let a=i();a.parentFork=Oe;let{forkInFlightCounter:n}=t.graphite.scope;n.scope.defers.push(a);let o=[t.find(e)],l=[];return E(e)?l.push({params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}):l.push(r),o.push(n),l.push(null),Ee({target:o,params:l,forkPage:t}),a.req}function A(e){let t=[];return function e(r){Ge(t,r)||(t.push(r),C(r,e))}(ie(e)),t}function C({next:e,family:t,meta:r},a){'fork'!==r.unit&&'forkInFlightCounter'!==r.unit&&(n(e,a),n(t.owners,a),n(t.links,a))}let O='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',D=e=>(W(e)||T(e))&&'kind'in e;const F=e=>t=>D(t)&&t.kind===e;let I=F('store'),_=F('event'),E=F('effect'),M=F('domain');var z={__proto__:null,unit:D,store:I,event:_,effect:E,domain:M};let R=e=>{throw Error(e)},T=e=>'object'==typeof e&&null!==e,W=e=>'function'==typeof e,H=e=>{T(e)||W(e)||R('expect first argument be an object')};const G=()=>{let e=0;return()=>(++e).toString(36)};let U=G(),$=G(),B=G(),J=(e,t)=>e.bind(null,t),K=(e,t,r)=>e.bind(null,t,r);const L=(e,t,r)=>({id:$(),type:e,data:r,hasRef:t});let Q=0,V=({priority:e="barrier"})=>L('barrier',0,{barrierID:++Q,priority:e}),X=({from:e="store",store:t,target:r,to:a=(r?'store':'stack')})=>L('mov','store'===e,{from:e,store:t,to:a,target:r}),Y={defined:()=>L('check',0,{type:'defined'}),changed:({store:e})=>L('check',1,{type:'changed',store:e})},Z=K(L,'compute',0),ee=K(L,'filter',0),te=K(L,'run',0),re=({store:e})=>X({from:'stack',target:e});var ae={__proto__:null,barrier:V,mov:X,check:Y,compute:Z,filter:ee,run:te,update:re};let ne=e=>({id:$(),current:e}),oe=({current:e})=>e,le=(e,{fn:t},{a:r})=>t(e,r),se=(e,{fn:t},{a:r})=>t(r,e),fe=(e,{fn:t})=>t(e),ie=e=>e.graphite||e,ce=e=>e.family.owners,ue=e=>e.family.links,pe=e=>e.stateRef,de=e=>e.config,me=e=>e.ɔ,he=e=>e.value,ge=e=>e.subscribers,ye=e=>e.parent,ke=(e,t)=>{let r=ie(e);for(let e=0;e<t.length;e++){let a=ie(t[e]);'domain'!==r.family.type&&(a.family.type='crosslink'),ce(a).push(r),ue(r).push(a)}};const be=(e=[])=>{let t=[];if(Array.isArray(e))for(let r=0;r<e.length;r++)Array.isArray(e[r])?t.push(...e[r]):t.push(e[r]);else t.push(e);return t.map(ie)};let ve=({hasRef:e,type:t,data:r},a)=>{let n;e&&(n=r.store,a[n.id]=n),'mov'===t&&'store'===r.to&&(n=r.target,a[n.id]=n)},we=null;const Se=(e,t)=>{if(!e)return t;if(!t)return e;let r,a=e.v.type===t.v.type;return(a&&e.v.id>t.v.id||!a&&'sampler'===e.v.type)&&(r=e,e=t,t=r),r=Se(e.r,t),e.r=e.l,e.l=r,e},qe=[];let xe=0;for(;xe<5;)qe.push({first:null,last:null,size:0}),xe+=1;const Pe=()=>{for(let e=0;e<5;e++){let t=qe[e];if(t.size>0){if(2===e||3===e){t.size-=1;let e=we.v;return we=Se(we.l,we.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Ne=(e,t,r,a,n,o)=>je(0,{a:null,b:null,node:r,parent:a,value:n,page:t,forkPage:o},e),je=(e,t,r,a=0)=>{let n=Ae(r),o=qe[n],l={v:{idx:e,stack:t,type:r,id:a},l:0,r:0};2===n||3===n?we=Se(we,l):(0===o.size?o.first=l:o.last.r=l,o.last=l),o.size+=1},Ae=e=>{switch(e){case'child':return 0;case'pure':return 1;case'barrier':return 2;case'sampler':return 3;case'effect':return 4;default:return-1}},Ce=new Set;let Oe,De=0,Fe=null,Ie=e=>{Oe=e},_e=e=>{Fe=e},Ee=(e,t,r)=>{let a=Fe,n=null,o=Oe;if(e.target&&(t=e.params,r=e.defer,a='page'in e?e.page:a,e.stack&&(n=e.stack),o=e.forkPage||o,e=e.target),Array.isArray(e))for(let r=0;r<e.length;r++)Ne('pure',a,ie(e[r]),n,t[r],o);else Ne('pure',a,ie(e),n,t,o);r&&De||(()=>{let e,t,r,a,n,o,l={alreadyStarted:De,currentPage:Fe,forkPage:Oe};De=1;e:for(;a=Pe();){let{idx:l,stack:s,type:f}=a;r=s.node,Fe=n=s.page,Oe=s.forkPage,o=(n||r).reg;let i={fail:0,scope:r.scope};e=t=0;for(let a=l;a<r.seq.length&&!e;a++){let c=r.seq[a],u=c.data;switch(c.type){case'barrier':{let e=u.barrierID;n&&(e=`${n.fullID}_${e}`);let t=u.priority;if(a!==l||f!==t){Ce.has(e)||(Ce.add(e),je(a,s,t,e));continue e}Ce.delete(e);break}case'mov':{let e;switch(u.from){case'stack':e=he(s);break;case'a':e=s.a;break;case'b':e=s.b;break;case'value':e=u.store;break;case'store':o[u.store.id]||(s.page=n=null,o=r.reg),e=oe(o[u.store.id])}switch(u.to){case'stack':s.value=e;break;case'a':s.a=e;break;case'b':s.b=e;break;case'store':o[u.target.id].current=e}break}case'check':switch(u.type){case'defined':t=void 0===he(s);break;case'changed':t=he(s)===oe(o[u.store.id])}break;case'filter':t=!Me(i,u,s);break;case'run':if(a!==l||'effect'!==f){je(a,s,'effect');continue e}case'compute':s.value=Me(i,u,s)}e=i.fail||t}if(!e)for(let e=0;e<r.next.length;e++)Ne('child',n,r.next[e],s,he(s),s.forkPage)}De=l.alreadyStarted,Fe=l.currentPage,Oe=l.forkPage})()};const Me=(e,{fn:t},r)=>{try{return t(he(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let ze=(e,t)=>''+e.shortName+t,Re=(e,t)=>null==t?ze(e,' → *'):t,Te=(e,t)=>{H(e),me(e)&&t(de(e),me(e))},We=e=>{let t;return Te(e[0],(r,a)=>{t=r,e=a}),[e,t]},He=(e,t)=>{for(let r in e)t(e[r],r)},Ge=(e,t)=>e.includes(t),Ue=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)};const $e=(e,t)=>{Ue(e.next,t),Ue(ce(e),t),Ue(ue(e),t)},Be=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=ue(e);for(;a=n.pop();)$e(a,e),(t||r&&!e.meta.sample||'crosslink'===a.family.type)&&Be(a,t,r);for(n=ce(e);a=n.pop();)$e(a,e),r&&'crosslink'===a.family.type&&Be(a,t,r)},Je=e=>e.clear();let Ke=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),I(e))Je(ge(e));else if(M(e)){r=1;let t=e.history;Je(t.events),Je(t.effects),Je(t.stores),Je(t.domains)}Be(ie(e),!!t,r)},Le=e=>{let t=K(Ke,e,void 0);return t.unsubscribe=t,t},Qe=e=>(Ve&&ke(he(Ve),[e]),e),Ve=null,Xe=()=>Ve&&Ve.template,Ye=(t,r,{node:a,scope:n,meta:o})=>Qe(e({node:a,parent:t,child:r,scope:n,meta:o,family:{owners:[t,r],links:r}})),Ze=t=>{let r;Te(t,(e,a)=>{r=e,t=a});let{from:a,to:n,meta:o={op:'forward'}}=t;return a&&n||R('from and to fields should be defined'),r&&(o.config=r),Le(Qe(e({parent:a,child:n,meta:o,family:{}})))},et=(t,r)=>{if(W(r)||R('.watch argument should be a function'),Oe){let e=Oe.nodeMap[ie(t).id];e&&(t=e)}return Le(Qe(e({scope:{fn:r},node:[te({fn:fe})],parent:t,meta:{op:'watch'},family:{owners:t}})))};const tt=(e,t)=>(T(e)&&(tt(de(e),t),null!=e.name&&(T(e.name)?tt(e.name,t):W(e.name)?t.handler=e.name:t.name=e.name),e.loc&&(t.loc=e.loc),(e.sid||null===e.sid)&&(t.sid=e.sid),e.handler&&(t.handler=e.handler),ye(e)&&(t.parent=ye(e)),'strict'in e&&(t.strict=e.strict),e.named&&(t.named=e.named),tt(me(e),t)),t);let rt,at=(e,t,r="event")=>{ye(e)&&ye(e).hooks[r](t)},nt=(e,t,r,n)=>{let o=tt({name:n,config:r},{}),l=U(),{parent:s=null,sid:f=null,strict:i=1,named:c=null}=o,u=c||o.name||('domain'===e?'':l),p=a(u,s);return t.kind=e,t.id=l,t.sid=f,t.shortName=u,t.parent=s,t.compositeName=p,t.defaultConfig=o,t.thru=e=>e(t),t.getType=()=>p.fullName,'domain'!==e&&(t.subscribe=e=>(H(e),t.watch(W(e)?e:t=>{e.next&&e.next(t)})),t[O]=()=>t),rt=i,{unit:e,name:u,sid:f,named:c}},ot=e=>l({named:e});const lt=(e,t,r,a)=>Ye(e,t,{scope:{fn:a},node:[Z({fn:fe})],meta:{op:r}}),st=(e,t,r,a)=>{let n;T(r)&&(n=r,r=r.fn);let o=l(ze(e,' →? *'),n);return Ye(e,o,{scope:{fn:r},node:a,meta:{op:t}}),o},ft=(e,t,r,a,n)=>{let o=pe(t),l=[X({store:o,to:'a'}),Z({fn:a?se:le}),Y.defined(),Y.changed({store:o}),re({store:o})],s=Xe();if(s&&(l.unshift(s.loader),l.push(s.upward),I(e))){let t=pe(e);Ge(s.plain,t)||(Ge(s.closure,t)||s.closure.push(t),o.before||(o.before=[]),o.before.push({type:'closure',of:t}))}return Ye(e,t,{scope:{fn:n},node:l,meta:{op:r}})},ct=e=>t=>e(...t),ut=(e,r,a,n)=>{let o=e?e=>e.slice():e=>Object.assign({},e),l=e?[]:{},f=Xe(),i=o(l),c=ne(i),u=ne(1);c.type=e?'list':'shape',f&&f.plain.push(c,u);let p=s(i,{name:a||t(r)}),d=[Y.defined(),X({store:c,to:'a'}),ee({fn:(e,{key:t},{a:r})=>e!==r[t]}),X({store:u,to:'b'}),Z({fn(e,{clone:t,key:r},a){a.b&&(a.a=t(a.a)),a.a[r]=e}}),X({from:'a',target:c}),X({from:'value',store:0,target:u}),V({priority:'barrier'}),X({from:'value',store:1,target:u}),X({store:c}),n&&Z({fn:n}),Y.changed({store:pe(p)})],m=c.before=[];return He(r,(e,t)=>{if(!I(e))return void(i[t]=l[t]=e);l[t]=e.defaultState,i[t]=e.getState();let r=Ye(e,p,{scope:{key:t,clone:o},node:d,meta:{op:'combine'}}),a=pe(e);m.push({type:'field',field:t,from:a}),f&&(Ge(f.plain,a)||r.seq.unshift(f.loader))}),p.defaultShape=r,c.after=[n?{type:'map',to:pe(p),fn:n}:{type:'copy',to:pe(p)}],f||(p.defaultState=n?pe(p).current=n(i):l),p};let pt=({params:e,req:t,ok:r,anyway:a,page:n,forkPage:o})=>l=>Ee({target:[a,dt],params:[r?{status:'done',params:e,result:l}:{status:'fail',params:e,error:l},{fn:r?t.rs:t.rj,value:l}],defer:1,page:n,forkPage:o});const dt=e({node:[te({fn({fn:e,value:t}){e(t)}})],meta:{op:'fx',fx:'sidechain'}}),mt=(e,t,r)=>(e.watch(e=>{ke(r,[e]),t.add(e),e.ownerSet||(e.ownerSet=t),ye(e)||(e.parent=r)}),ke(r,[e]),r=>(t.forEach(r),e.watch(r))),ht="21.4.2";export{j as allSettled,u as attach,Ke as clearNode,f as combine,p as createApi,d as createDomain,c as createEffect,l as createEvent,e as createNode,s as createStore,f as createStoreObject,P as fork,Ze as forward,m as fromObservable,g as guard,v as hydrate,z as is,Ee as launch,y as merge,k as restore,h as sample,q as scopeBind,S as serialize,r as setStoreName,b as split,ae as step,ht as version,o as withRegion};
//# sourceMappingURL=effector.mjs.map

((e,t)=>{'object'==typeof exports&&'undefined'!=typeof module?t(exports):'function'==typeof define&&define.amd?define(['exports'],t):t((e=e||self).effector={})})(this,e=>{function t({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:l=n||o,scope:s={},meta:f={},family:i={type:'regular'}}={}){let c=oe(a),u=oe(i.links),p=oe(i.owners),d=[],m={};for(let t=0;t<e.length;t++){let r=e[t];r&&(d.push(r),le(r,m))}let h={id:D(),seq:d,next:oe(l),meta:f,scope:s,family:{type:i.type||'crosslink',links:u,owners:p},reg:m};for(let e=0;e<u.length;e++)V(u[e]).push(h);for(let e=0;e<p.length;e++)X(p[e]).push(h);for(let e=0;e<c.length;e++)c[e].next.push(h);return h}function r(e,t="combine"){let r=t+'(',a='',n=0;for(let t in e){let o=e[t];if(null!=o&&(r+=a,r+=y(o)?o.compositeName.fullName:o.toString()),n+=1,25===n)break;a=', '}return r+=')',r}function a(e,t){let r,a,n,o=e;return t?(n=t.compositeName,0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)):(r=0===e.length?[]:[e],a=e),{shortName:o,fullName:a,path:r}}function n(e,t){e.forEach(t)}function o(e,r){let a=(e,...t)=>ke?((e,t,r,a)=>{let n=ke,o=null;if(t)for(o=ke;o&&o.template!==t;)o=ae(o);ve(o);let l=e.create(r,a);return ve(n),l})(a,n,e,t):a.create(e,t);a.graphite=t({meta:Ue('event',a,r,e)}),a.create=e=>{let t=ge?ge.find(a):a;return we(t,e),e},a.watch=_(We,a),a.map=e=>{let t,r;N(e)&&(t=e,r=e.name,e=e.fn);let n=o(xe(a,r),t);return Je(a,n,'map',e),n},a.filter=e=>Ke(a,'filter',e.fn?e:e.fn,[W({fn:L})]),a.filterMap=e=>Ke(a,'filterMap',e,[T({fn:L}),R.defined()]),a.prepend=e=>{let t=o('* → '+a.shortName,{parent:ae(a)}),r=ze();return r&&Q(t).seq.push(r.upward),Je(t,a,'prepend',e),Ge(a,t),t};let n=ze();return n&&(Q(a).meta.nativeTemplate=n),Ie(a)}function l(e,r){function a(e,t){c.off(e),re(c).set(e,Fe(Le(e,c,'on',1,t)))}let n=U(e),o=U(e),s=$e('updates'),f=ze();n.after=[{type:'copy',to:o}],f&&f.plain.push(n,o);let i=n.id,c={subscribers:new Map,updates:s,defaultState:e,stateRef:n,getState(){let e,t=n;if(ke){let t=ke;for(;t&&!t.reg[i];)t=ae(t);t&&(e=t)}return!e&&ge&&ge.reg[i]&&(e=ge),e&&(t=e.reg[i]),$(t)},setState(e){let t;ge&&(t=ge.nodeMap[Q(c).id]),t||(t=c),we({target:t,params:e,defer:1})},reset(...e){for(let t of e)c.on(t,()=>c.defaultState);return c},on(e,t){if(Array.isArray(e))for(let r of e)a(r,t);else a(e,t);return c},off(e){let t=re(c).get(e);return t&&(t(),re(c).delete(e)),c},map(e,t){let r,a,o;N(e)&&(r=e,a=e.name,t=e.firstState,e=e.fn);let s=c.getState(),f=ze();f?o=null:void 0!==s&&(o=e(s,t));let i=l(o,{name:xe(c,a),config:r,strict:0}),u=Le(c,i,'map',0,e);return Y(i).before=[{type:'map',fn:e,from:n}],f&&(Oe(f.plain,n)||Oe(u.seq,f.loader)||u.seq.unshift(f.loader)),i},watch(e,t){if(!t||!y(e)){let t=We(c,e),r=ze();return r?r.watch.push({of:n,fn:e}):e(c.getState()),t}return P(t)||x('second argument should be a function'),e.watch(e=>t(c.getState(),e))}};return c.graphite=t({scope:{state:n},node:[R.defined(),B({store:n}),R.changed({store:o}),B({store:o})],child:s,meta:Ue('store',c,r)}),Be&&void 0===e&&x("current state can't be undefined, use null instead"),f&&(Q(c).meta.nativeTemplate=f),ne(c,[s]),Ie(c)}function s(...e){let t,r,a;Ne(e[0],(t,r)=>{a=t,e=r});let n,o,l=e[e.length-1];if(P(l)?(r=e.slice(0,-1),t=l):r=e,1===r.length){let e=r[0];b(e)||(n=e,o=1)}return o||(n=r,t&&(t=Qe(t))),N(n)||x('shape should be an object'),Ve(Array.isArray(n),n,a,t)}function f(){let e={};return e.req=new Promise((t,r)=>{e.rs=t,e.rj=r}),e.req.catch(()=>{}),e}function i(e,r){let a=o(e,r),n=a.defaultConfig.handler||(()=>x("no handler used in "+a.getType()));Q(a).meta.onCopy=['runner'],Q(a).meta.unit=a.kind='effect',a.use=e=>(P(e)||x('.use argument should be a function'),n=e,a);let s=a.finally=$e('finally'),i=a.done=s.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),c=a.fail=s.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),u=a.doneData=i.map({named:'doneData',fn:({result:e})=>e}),p=a.failData=c.map({named:'failData',fn:({error:e})=>e}),d=t({scope:{getHandler:a.use.getCurrent=()=>n,finally:s},node:[H({fn({params:e,req:t},{finally:r,getHandler:a},{page:n,forkPage:o}){let l,s=Xe({params:e,req:t,ok:1,anyway:r,page:n,forkPage:o}),f=Xe({params:e,req:t,ok:0,anyway:r,page:n,forkPage:o});try{l=a()(e)}catch(e){return void f(e)}N(l)&&P(l.then)?l.then(s,f):s(l)}})],meta:{op:'fx',fx:'runner',onCopy:['finally']}});Q(a).scope.runner=d,Q(a).seq.push(T({fn:(e,t,r)=>ae(r)?{params:e,req:{rs(e){},rj(e){}}}:e}),H({fn:(e,{runner:t},{forkPage:r})=>(we({target:t,params:e,defer:1,forkPage:r}),e.params)})),a.create=e=>{let t=f(),r={params:e,req:t};if(ge){let e=ge;t.req.finally(()=>{be(e)}),we(ge.find(a),r)}else we(a,r);return t.req};let m=a.inFlight=l(0,{named:'inFlight'}).on(a,e=>e+1).on(s,e=>e-1),h=a.pending=m.map({fn:e=>e>0,named:'pending'});return ne(a,[s,i,c,u,p,h,m,d]),a}function c(...e){let r,a,n,f,[[i,c,u],p]=Pe(e);void 0===c&&'source'in i&&('clock'in i&&null==i.clock&&x('config.clock should be defined'),c=i.clock,u=i.fn,f=i.greedy,r=i.target,a=i.name,n=i.sid,i=i.source),y(i)||(i=s(i)),void 0===c&&(c=i),a=p||a||i.shortName;let d=ze(),m=!!r;r||(b(i)&&b(c)?r=l(u?u($(Y(i)),$(Y(c))):$(Y(i)),{name:a,sid:n}):(r=o(a),d&&Q(r).seq.push(d.loader)));let h=m&&y(r)&&Q(r).meta.nativeTemplate;if(b(i)){let e=Y(i);ne(i,[Re(c,r,{scope:{fn:u,targetTemplate:h},node:[d&&d.loader,!f&&M({priority:'sampler'}),z({store:e,to:u?'a':'stack'}),u&&T({fn:K}),d&&m&&d.upward],meta:{op:'sample',sample:'store'}})]),d&&(Oe(d.plain,e)||Oe(d.closure,e)||d.closure.push(e))}else{let e=U(0),a=U(),n=U();d&&d.plain.push(e,a,n),Ie(t({parent:i,node:[B({store:a}),z({from:'value',store:1,target:e})],family:{owners:[i,r,c],links:r},meta:{op:'sample',sample:'source'}})),ne(i,[Re(c,r,{scope:{fn:u,targetTemplate:h},node:[d&&d.loader,B({store:n}),z({store:e}),W({fn:e=>e}),!f&&M({priority:'sampler'}),z({store:a}),z({store:n,to:'a'}),u&&T({fn:J}),d&&m&&d.upward],meta:{op:'sample',sample:'clock'}})])}return r}function u(e){let t=Object.values(e),r={};for(let{id:e}of t)r[e]=[];for(let{id:e,before:a,after:o}of t)a&&n(a,t=>{r[t.from.id].push(e)}),o&&n(o,t=>{r[e].push(t.to.id)});return r}function p(e){if(e instanceof Map){let t={};for(let[r,a]of e)t[r.sid]=a;return t}return e}function d(e,t){function r(e){s[e]=1;let t=a[e];for(let e=0;e<t.length;e++){let a=t[e];s[a]||l[a]||r(a)}s[e]=0,l[e]=1,o.push(e)}let a={};for(let t in e)a[t]=[...new Set(e[t])];let o=[],l={},s={};for(let e in a)l[e]||s[e]||r(e);if(o.reverse(),t&&t.size>0){let e,r=[],l=[...t];for(;e=l.shift();)r.push(e),n(a[e],e=>{Oe(r,e)||Oe(l,e)||l.push(e)});n(r,e=>{Ae(o,e)})}return o}function m(e){let t=[];return function e(r){Oe(t,r)||(t.push(r),h(r,e))}(Q(e)),t}function h({next:e,family:t,meta:r},a){'fork'!==r.unit&&'forkInFlightCounter'!==r.unit&&(n(e,a),n(t.owners,a),n(t.links,a))}let g='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',y=e=>(P(e)||N(e))&&'kind'in e;const k=e=>t=>y(t)&&t.kind===e;let b=k('store'),v=k('event'),w=k('effect'),S=k('domain');var q={__proto__:null,unit:y,store:b,event:v,effect:w,domain:S};let x=e=>{throw Error(e)},N=e=>'object'==typeof e&&null!==e,P=e=>'function'==typeof e,j=e=>{N(e)||P(e)||x('expect first argument be an object')};const O=()=>{let e=0;return()=>(++e).toString(36)};let A=O(),C=O(),D=O(),_=(e,t)=>e.bind(null,t),E=(e,t,r)=>e.bind(null,t,r);const F=(e,t,r)=>({id:C(),type:e,data:r,hasRef:t});let I=0,M=({priority:e="barrier"})=>F('barrier',0,{barrierID:++I,priority:e}),z=({from:e="store",store:t,target:r,to:a=(r?'store':'stack')})=>F('mov','store'===e,{from:e,store:t,to:a,target:r}),R={defined:()=>F('check',0,{type:'defined'}),changed:({store:e})=>F('check',1,{type:'changed',store:e})},T=E(F,'compute',0),W=E(F,'filter',0),H=E(F,'run',0),B=({store:e})=>z({from:'stack',target:e});var G={__proto__:null,barrier:M,mov:z,check:R,compute:T,filter:W,run:H,update:B};let U=e=>({id:C(),current:e}),$=({current:e})=>e,J=(e,{fn:t},{a:r})=>t(e,r),K=(e,{fn:t},{a:r})=>t(r,e),L=(e,{fn:t})=>t(e),Q=e=>e.graphite||e,V=e=>e.family.owners,X=e=>e.family.links,Y=e=>e.stateRef,Z=e=>e.config,ee=e=>e.ɔ,te=e=>e.value,re=e=>e.subscribers,ae=e=>e.parent,ne=(e,t)=>{let r=Q(e);for(let e=0;e<t.length;e++){let a=Q(t[e]);'domain'!==r.family.type&&(a.family.type='crosslink'),V(a).push(r),X(r).push(a)}};const oe=(e=[])=>{let t=[];if(Array.isArray(e))for(let r=0;r<e.length;r++)Array.isArray(e[r])?t.push(...e[r]):t.push(e[r]);else t.push(e);return t.map(Q)};let le=({hasRef:e,type:t,data:r},a)=>{let n;e&&(n=r.store,a[n.id]=n),'mov'===t&&'store'===r.to&&(n=r.target,a[n.id]=n)},se=null;const fe=(e,t)=>{if(!e)return t;if(!t)return e;let r,a=e.v.type===t.v.type;return(a&&e.v.id>t.v.id||!a&&'sampler'===e.v.type)&&(r=e,e=t,t=r),r=fe(e.r,t),e.r=e.l,e.l=r,e},ie=[];let ce=0;for(;ce<5;)ie.push({first:null,last:null,size:0}),ce+=1;const ue=()=>{for(let e=0;e<5;e++){let t=ie[e];if(t.size>0){if(2===e||3===e){t.size-=1;let e=se.v;return se=fe(se.l,se.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},pe=(e,t,r,a,n,o)=>de(0,{a:null,b:null,node:r,parent:a,value:n,page:t,forkPage:o},e),de=(e,t,r,a=0)=>{let n=me(r),o=ie[n],l={v:{idx:e,stack:t,type:r,id:a},l:0,r:0};2===n||3===n?se=fe(se,l):(0===o.size?o.first=l:o.last.r=l,o.last=l),o.size+=1},me=e=>{switch(e){case'child':return 0;case'pure':return 1;case'barrier':return 2;case'sampler':return 3;case'effect':return 4;default:return-1}},he=new Set;let ge,ye=0,ke=null,be=e=>{ge=e},ve=e=>{ke=e},we=(e,t,r)=>{let a=ke,n=null,o=ge;if(e.target&&(t=e.params,r=e.defer,a='page'in e?e.page:a,e.stack&&(n=e.stack),o=e.forkPage||o,e=e.target),Array.isArray(e))for(let r=0;r<e.length;r++)pe('pure',a,Q(e[r]),n,t[r],o);else pe('pure',a,Q(e),n,t,o);r&&ye||(()=>{let e,t,r,a,n,o,l={alreadyStarted:ye,currentPage:ke,forkPage:ge};ye=1;e:for(;a=ue();){let{idx:l,stack:s,type:f}=a;r=s.node,ke=n=s.page,ge=s.forkPage,o=(n||r).reg;let i={fail:0,scope:r.scope};e=t=0;for(let a=l;a<r.seq.length&&!e;a++){let c=r.seq[a],u=c.data;switch(c.type){case'barrier':{let e=u.barrierID;n&&(e=`${n.fullID}_${e}`);let t=u.priority;if(a!==l||f!==t){he.has(e)||(he.add(e),de(a,s,t,e));continue e}he.delete(e);break}case'mov':{let e;switch(u.from){case'stack':e=te(s);break;case'a':e=s.a;break;case'b':e=s.b;break;case'value':e=u.store;break;case'store':o[u.store.id]||(s.page=n=null,o=r.reg),e=$(o[u.store.id])}switch(u.to){case'stack':s.value=e;break;case'a':s.a=e;break;case'b':s.b=e;break;case'store':o[u.target.id].current=e}break}case'check':switch(u.type){case'defined':t=void 0===te(s);break;case'changed':t=te(s)===$(o[u.store.id])}break;case'filter':t=!Se(i,u,s);break;case'run':if(a!==l||'effect'!==f){de(a,s,'effect');continue e}case'compute':s.value=Se(i,u,s)}e=i.fail||t}if(!e)for(let e=0;e<r.next.length;e++)pe('child',n,r.next[e],s,te(s),s.forkPage)}ye=l.alreadyStarted,ke=l.currentPage,ge=l.forkPage})()};const Se=(e,{fn:t},r)=>{try{return t(te(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let qe=(e,t)=>''+e.shortName+t,xe=(e,t)=>null==t?qe(e,' → *'):t,Ne=(e,t)=>{j(e),ee(e)&&t(Z(e),ee(e))},Pe=e=>{let t;return Ne(e[0],(r,a)=>{t=r,e=a}),[e,t]},je=(e,t)=>{for(let r in e)t(e[r],r)},Oe=(e,t)=>e.includes(t),Ae=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)};const Ce=(e,t)=>{Ae(e.next,t),Ae(V(e),t),Ae(X(e),t)},De=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=X(e);for(;a=n.pop();)Ce(a,e),(t||r&&!e.meta.sample||'crosslink'===a.family.type)&&De(a,t,r);for(n=V(e);a=n.pop();)Ce(a,e),r&&'crosslink'===a.family.type&&De(a,t,r)},_e=e=>e.clear();let Ee=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),b(e))_e(re(e));else if(S(e)){r=1;let t=e.history;_e(t.events),_e(t.effects),_e(t.stores),_e(t.domains)}De(Q(e),!!t,r)},Fe=e=>{let t=E(Ee,e,void 0);return t.unsubscribe=t,t},Ie=e=>(Me&&ne(te(Me),[e]),e),Me=null,ze=()=>Me&&Me.template,Re=(e,r,{node:a,scope:n,meta:o})=>Ie(t({node:a,parent:e,child:r,scope:n,meta:o,family:{owners:[e,r],links:r}})),Te=e=>{let r;Ne(e,(t,a)=>{r=t,e=a});let{from:a,to:n,meta:o={op:'forward'}}=e;return a&&n||x('from and to fields should be defined'),r&&(o.config=r),Fe(Ie(t({parent:a,child:n,meta:o,family:{}})))},We=(e,r)=>{if(P(r)||x('.watch argument should be a function'),ge){let t=ge.nodeMap[Q(e).id];t&&(e=t)}return Fe(Ie(t({scope:{fn:r},node:[H({fn:L})],parent:e,meta:{op:'watch'},family:{owners:e}})))};const He=(e,t)=>(N(e)&&(He(Z(e),t),null!=e.name&&(N(e.name)?He(e.name,t):P(e.name)?t.handler=e.name:t.name=e.name),e.loc&&(t.loc=e.loc),(e.sid||null===e.sid)&&(t.sid=e.sid),e.handler&&(t.handler=e.handler),ae(e)&&(t.parent=ae(e)),'strict'in e&&(t.strict=e.strict),e.named&&(t.named=e.named),He(ee(e),t)),t);let Be,Ge=(e,t,r="event")=>{ae(e)&&ae(e).hooks[r](t)},Ue=(e,t,r,n)=>{let o=He({name:n,config:r},{}),l=A(),{parent:s=null,sid:f=null,strict:i=1,named:c=null}=o,u=c||o.name||('domain'===e?'':l),p=a(u,s);return t.kind=e,t.id=l,t.sid=f,t.shortName=u,t.parent=s,t.compositeName=p,t.defaultConfig=o,t.thru=e=>e(t),t.getType=()=>p.fullName,'domain'!==e&&(t.subscribe=e=>(j(e),t.watch(P(e)?e:t=>{e.next&&e.next(t)})),t[g]=()=>t),Be=i,{unit:e,name:u,sid:f,named:c}},$e=e=>o({named:e});const Je=(e,t,r,a)=>Re(e,t,{scope:{fn:a},node:[T({fn:L})],meta:{op:r}}),Ke=(e,t,r,a)=>{let n;N(r)&&(n=r,r=r.fn);let l=o(qe(e,' →? *'),n);return Re(e,l,{scope:{fn:r},node:a,meta:{op:t}}),l},Le=(e,t,r,a,n)=>{let o=Y(t),l=[z({store:o,to:'a'}),T({fn:a?K:J}),R.defined(),R.changed({store:o}),B({store:o})],s=ze();if(s&&(l.unshift(s.loader),l.push(s.upward),b(e))){let t=Y(e);Oe(s.plain,t)||(Oe(s.closure,t)||s.closure.push(t),o.before||(o.before=[]),o.before.push({type:'closure',of:t}))}return Re(e,t,{scope:{fn:n},node:l,meta:{op:r}})},Qe=e=>t=>e(...t),Ve=(e,t,a,n)=>{let o=e?e=>e.slice():e=>Object.assign({},e),s=e?[]:{},f=ze(),i=o(s),c=U(i),u=U(1);c.type=e?'list':'shape',f&&f.plain.push(c,u);let p=l(i,{name:a||r(t)}),d=[R.defined(),z({store:c,to:'a'}),W({fn:(e,{key:t},{a:r})=>e!==r[t]}),z({store:u,to:'b'}),T({fn(e,{clone:t,key:r},a){a.b&&(a.a=t(a.a)),a.a[r]=e}}),z({from:'a',target:c}),z({from:'value',store:0,target:u}),M({priority:'barrier'}),z({from:'value',store:1,target:u}),z({store:c}),n&&T({fn:n}),R.changed({store:Y(p)})],m=c.before=[];return je(t,(e,t)=>{if(!b(e))return void(i[t]=s[t]=e);s[t]=e.defaultState,i[t]=e.getState();let r=Re(e,p,{scope:{key:t,clone:o},node:d,meta:{op:'combine'}}),a=Y(e);m.push({type:'field',field:t,from:a}),f&&(Oe(f.plain,a)||r.seq.unshift(f.loader))}),p.defaultShape=t,c.after=[n?{type:'map',to:Y(p),fn:n}:{type:'copy',to:Y(p)}],f||(p.defaultState=n?Y(p).current=n(i):s),p};let Xe=({params:e,req:t,ok:r,anyway:a,page:n,forkPage:o})=>l=>we({target:[a,Ye],params:[r?{status:'done',params:e,result:l}:{status:'fail',params:e,error:l},{fn:r?t.rs:t.rj,value:l}],defer:1,page:n,forkPage:o});const Ye=t({node:[H({fn({fn:e,value:t}){e(t)}})],meta:{op:'fx',fx:'sidechain'}}),Ze=(e,t,r)=>(e.watch(e=>{ne(r,[e]),t.add(e),e.ownerSet||(e.ownerSet=t),ae(e)||(e.parent=r)}),ne(r,[e]),r=>(t.forEach(r),e.watch(r)));e.allSettled=(e,{scope:t,params:r})=>{if(!y(e))return Promise.reject(Error('first argument should be unit'));let a=f();a.parentFork=ge;let{forkInFlightCounter:n}=t.graphite.scope;n.scope.defers.push(a);let o=[t.find(e)],l=[];return w(e)?l.push({params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}):l.push(r),o.push(n),l.push(null),we({target:o,params:l,forkPage:t}),a.req},e.attach=e=>{let t;Ne(e,(r,a)=>{t=r,e=a});let{source:r,effect:a,mapParams:n}=e;r||n||x('either `mapParams` or `source` should be defined'),n||(n=(e,t)=>t);let o,l=i(e,t),{runner:f}=Q(l).scope,c=({params:e,req:t},{finally:r,effect:a},{a:o,page:l,forkPage:s})=>{let f,i=Xe({params:e,req:t,ok:0,anyway:r,page:l,forkPage:s});try{f=n(e,o)}catch(e){return i(e)}we({target:a,params:{params:f,req:{rs:Xe({params:e,req:t,ok:1,anyway:r,page:l,forkPage:s}),rj:i}},page:l,defer:1})};if(r){let e;b(r)?e=r:(e=s(r),ne(l,[e]));let t=z({from:'store',store:Y(e),to:'a'});o=[H({fn:e=>e}),t,T({fn:c})],le(t,f.reg)}else o=[H({fn:c})];return f.scope.effect=a,f.meta.onCopy.push('effect'),f.seq.splice(0,1,...o),Ge(a,l,'effect'),l},e.clearNode=Ee,e.combine=s,e.createApi=(...e)=>{let[[t,r],a]=Pe(e),n={};return je(r,(e,r)=>{let l=n[r]=o(r,{parent:ae(t),config:a});t.on(l,e),Ge(t,l)}),n},e.createDomain=function e(r,a){let n=new Set,s=new Set,f=new Set,c=new Set,u=t({family:{type:'domain'}}),p={history:{domains:n,stores:s,effects:f,events:c},graphite:u};u.meta=Ue('domain',p,a,r);let[d,m,h,g]=['onEvent','onEffect','onStore','onDomain'].map($e);p.hooks={event:d,effect:m,store:h,domain:g},p.onCreateEvent=Ze(d,c,p),p.onCreateEffect=Ze(m,f,p),p.onCreateStore=Ze(h,s,p),p.onCreateDomain=Ze(g,n,p),p.createEvent=p.event=(e,t)=>d(o(e,{parent:p,config:t})),p.createEffect=p.effect=(e,t)=>m(i(e,{parent:p,config:t})),p.createDomain=p.domain=(t,r)=>e({name:t,parent:p,config:r}),p.createStore=p.store=(e,t)=>h(l(e,{parent:p,config:t})),Ie(p);let y=ae(p);return y&&(je(p.hooks,(e,t)=>{Te({from:e,to:y.hooks[t]})}),y.hooks.domain(p)),p},e.createEffect=i,e.createEvent=o,e.createNode=t,e.createStore=l,e.createStoreObject=s,e.fork=(e,{values:r,handlers:a}={})=>{S(e)||x('first argument of fork should be domain');let o=!!r;r=p(r||{});let l=(e=>{function r(e){e=Q(e);let t=a.indexOf(e);return-1===t&&x('unit not found in forked scope'),i[t]}let a=m(e),o=new Map,l=T({fn:(e,t,r)=>(be(r.forkPage),e)}),s=t({scope:{defers:[],inFlight:0,fxID:0},node:[T({fn(e,t,r){r.parent?'finally'===r.parent.node.meta.named?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1}}),M({priority:'sampler'}),H({fn(e,t){let{inFlight:r,defers:a,fxID:o}=t;r>0||0===a.length||Promise.resolve().then(()=>{t.fxID===o&&n(a.splice(0,a.length),e=>{be(e.parentFork),e.rs(e.value)})})}})],meta:{unit:'forkInFlightCounter'}}),f={},i=a.map(e=>{let{seq:r,next:a,meta:n,scope:o,family:l}=e,s=t({node:r.map(e=>({id:e.id,type:e.type,data:Object.assign({},e.data),hasRef:e.hasRef})),child:[...a],meta:Object.assign({forkOf:e},n),scope:Object.assign({},o)});return s.family={type:l.type,links:[...l.links],owners:[...l.owners]},f[e.id]=s,s}),c={};return n(i,e=>{let{reg:t,scope:a,meta:{onCopy:n,op:f,unit:i}}=e;for(let e in t){let r=t[e],a=o.get(r);a||(a={id:r.id,current:r.current},o.set(r,a)),c[e]=t[e]=a}if(n)for(let e=0;e<n.length;e++)a[n[e]]=r(a[n[e]]);switch(h(e,(e,t,a)=>{a[t]=r(e)}),f||i){case'store':e.meta.wrapped=(e=>({kind:'store',getState:()=>e.reg[e.scope.state.id].current,updates:{watch:_(We,e)},graphite:e,family:e.family}))(e);break;case'event':e.seq.unshift(l);break;case'effect':e.next.push(s),e.seq.unshift(l);break;case'fx':a.finally.next.push(s),e.seq.unshift(l);break;case'watch':e.seq.unshift(l)}}),{cloneOf:e,nodeMap:f,clones:i,find:r,reg:c,getState:e=>r(e).meta.wrapped.getState(),graphite:t({family:{type:'domain',links:[s,...i]},meta:{unit:'fork'},scope:{forkInFlightCounter:s}})}})(e);if(o&&(()=>{let t=m(e),a={},o={},s=new Set,f=new Set,i=Object.getOwnPropertyNames(r);for(let{reg:e,meta:r}of t){let{nativeTemplate:t}=r;for(let r in e)a[r]=e[r],t&&f.add(r)}for(let e of l.clones){let{reg:t}=e,{unit:a,sid:n}=e.meta;if('store'===a&&n&&Oe(i,n)){let{state:a}=e.scope;t[a.id].current=r[n],s.add(a)}for(let e in t)o[e]=t[e]}n(d(u(a),f),e=>{((e,t)=>{let r=0;if(t&&t.before&&!s.has(e))for(let a of t.before)switch(a.type){case'map':e.current=a.fn(o[a.from.id].current);break;case'field':{let t=o[a.from.id];r||(r=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[a.field]=t.current;break}}if(!t||!t.after)return;let a=e.current;for(let e of t.after){let t=o[e.to.id];switch(e.type){case'copy':t.current=a;break;case'map':t.current=e.fn(a)}}})(o[e],a[e])})})(),a){a=p(a);let e=Object.keys(a);for(let{scope:t,meta:r}of l.clones)r.sid&&Oe(e,r.sid)&&(t.runner.scope.getHandler=()=>a[r.sid])}return l},e.forward=Te,e.fromObservable=e=>{j(e);let t=g in e?e[g]():e;t.subscribe||x('expect observable to have .subscribe');let r=o(),a=E(Ee,r,void 0);return t.subscribe({next:r,error:a,complete:a}),r},e.guard=(...e)=>{let r={op:'guard'},a='guard',[[n,l],f]=Pe(e);f&&(r.config=f,f.name&&(a=f.name)),l||(l=n,n=l.source);let{filter:i,greedy:u,name:p=a}=l,d=l.target||o(p,r.config);return y(n)||(n=s(n)),y(i)?c({source:i,clock:n,target:Ie(t({node:[W({fn:({guard:e})=>e}),T({fn:({data:e})=>e})],child:d,meta:r,family:{owners:[n,i,d],links:d}})),fn:(e,t)=>({guard:e,data:t}),greedy:u,name:p}):(P(i)||x('`filter` should be function or unit'),Re(n,d,{scope:{fn:i},node:[W({fn:L})],meta:r})),d},e.hydrate=(e,{values:t})=>{S(e)||x('first argument of hydrate should be domain'),N(t)||x('values property should be an object');let{storeWatches:r,storeWatchesRefs:a}=(({flatGraphUnits:e,values:t,collectWatches:r})=>{let a=[],o=[],l={},s=new Set,f=Object.getOwnPropertyNames(t);for(let n of e){let{reg:e}=n,{op:i,unit:c,sid:u}=n.meta;if('store'===c&&u&&Oe(f,u)){let{state:e}=n.scope;e.current=t[u],s.add(e)}if(r&&'watch'===i){let e=n.family.owners[0];'store'===e.meta.unit&&(a.push(n),o.push(e.scope.state))}for(let t in e)l[t]=e[t]}return n(d(u(l)),e=>{(e=>{let t=0;if(e.before&&!s.has(e))for(let r of e.before)switch(r.type){case'map':e.current=r.fn(r.from.current);break;case'field':{let a=r.from;t||(t=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[r.field]=a.current;break}}if(!e.after)return;let r=e.current;for(let t of e.after){let e=t.to;switch(t.type){case'copy':e.current=r;break;case'map':e.current=t.fn(r)}}})(l[e])}),{storeWatches:a,storeWatchesRefs:o}})({flatGraphUnits:m(e),values:p(t),collectWatches:1});we({target:r,params:a.map(({current:e})=>e)})},e.is=q,e.launch=we,e.merge=e=>{let t=o(r(e,'merge'));return Te({from:e,to:t,meta:{op:'merge'}}),t},e.restore=(e,t,r)=>{if(b(e))return e;if(y(e)){let a,n=ae(e);return v(e)&&(a=l(t,{parent:n,name:e.shortName,ɔ:r}).on(e,(e,t)=>t)),w(e)&&(a=l(t,{parent:n,name:e.shortName,ɔ:r}).on(e.done,(e,{result:t})=>t)),n&&n.hooks.store(a),a}let a=Array.isArray(e)?[]:{};return je(e,(e,t)=>{a[t]=b(e)?e:l(e,{name:t})}),a},e.sample=c,e.scopeBind=e=>{ge||x('scopeBind cannot be called outside of forked .watch');let t=ge.find(e),r=ge;return e=>{we({target:t,params:e,forkPage:r})}},e.serialize=({clones:e,getState:t,cloneOf:r},{ignore:a=[],onlyChanges:n}={})=>{let o={};if(n){a=[...a];for(let e of r.history.stores)t(e)===e.defaultState&&a.push(e)}for(let{meta:t,scope:r,reg:a}of e){if('store'!==t.unit)continue;let{sid:e}=t;e&&(o[e]=a[r.state.id].current)}for(let{sid:e}of a)e&&delete o[e];return o},e.setStoreName=(e,t)=>{let r=a(t,ae(e));if(e.shortName=t,!e.compositeName)return void(e.compositeName=r);let n=e.compositeName;n.path=r.path,n.shortName=r.shortName,n.fullName=r.fullName},e.split=(...e)=>{let t,[[r,a],n]=Pe(e),o=!a;o&&(t=r.cases,a=r.match,r=r.source);let l={},s=b(r)?r.updates:r;if(je(a,(e,t)=>{l[t]=s.filter({fn:e,config:n}),s=s.filter({fn:t=>!e(t),config:n})}),l.__=s,!o)return l;je(l,(e,r)=>{t[r]&&Te({from:e,to:t[r]})})},e.step=G,e.version="21.4.2",e.withRegion=(e,t)=>{Me={parent:Me,value:e,template:Q(e).meta.template||Me&&Me.template};try{return t()}finally{Me=ae(Me)}},Object.defineProperty(e,'__esModule',{value:1})});
//# sourceMappingURL=effector.umd.js.map

function e({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:s=n||o,scope:l={},meta:f={},family:i={type:'regular'}}={}){let c=ne(a),p=ne(i.links),u=ne(i.owners),d=[],m={};for(let t=0;t<e.length;t++){let r=e[t];r&&(d.push(r),oe(r,m))}let h={id:C(),seq:d,next:ne(s),meta:f,scope:l,family:{type:i.type||'crosslink',links:p,owners:u},reg:m};for(let e=0;e<p.length;e++)Q(p[e]).push(h);for(let e=0;e<u.length;e++)V(u[e]).push(h);for(let e=0;e<c.length;e++)c[e].next.push(h);return h}function t(e,t="combine"){let r=t+'(',a='',n=0;for(let t in e){let o=e[t];if(null!=o&&(r+=a,r+=g(o)?o.compositeName.fullName:o.toString()),n+=1,25===n)break;a=', '}return r+=')',r}function r(e,t){let r,a,n,o=e;return t?(n=t.compositeName,0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)):(r=0===e.length?[]:[e],a=e),{shortName:o,fullName:a,path:r}}function a(e,t){e.forEach(t)}function n(t,r){let a=(e,...t)=>ye?((e,t,r,a)=>{let n=ye,o=null;if(t)for(o=ye;o&&o.template!==t;)o=re(o);be(o);let s=e.create(r,a);return be(n),s})(a,o,e,t):a.create(e,t);a.graphite=e({meta:Ge('event',a,r,t)}),a.create=e=>{let t=he?he.find(a):a;return ve(t,e),e},a.watch=D(Te,a),a.map=e=>{let t,r;q(e)&&(t=e,r=e.name,e=e.fn);let o=n(Se(a,r),t);return $e(a,o,'map',e),o},a.filter=e=>Je(a,'filter',e.fn?e:e.fn,[T({fn:K})]),a.filterMap=e=>Je(a,'filterMap',e,[R({fn:K}),z.defined()]),a.prepend=e=>{let t=n('* → '+a.shortName,{parent:re(a)}),r=Me();return r&&L(t).seq.push(r.upward),$e(t,a,'prepend',e),Be(a,t),t};let o=Me();return o&&(L(a).meta.nativeTemplate=o),Fe(a)}function o(t,r){function a(e,t){c.off(e),te(c).set(e,Ee(Ke(e,c,'on',1,t)))}let n=G(t),s=G(t),l=Ue('updates'),f=Me();n.after=[{type:'copy',to:s}],f&&f.plain.push(n,s);let i=n.id,c={subscribers:new Map,updates:l,defaultState:t,stateRef:n,getState(){let e,t=n;if(ye){let t=ye;for(;t&&!t.reg[i];)t=re(t);t&&(e=t)}return!e&&he&&he.reg[i]&&(e=he),e&&(t=e.reg[i]),U(t)},setState(e){let t;he&&(t=he.nodeMap[L(c).id]),t||(t=c),ve({target:t,params:e,defer:1})},reset(...e){for(let t of e)c.on(t,()=>c.defaultState);return c},on(e,t){if(Array.isArray(e))for(let r of e)a(r,t);else a(e,t);return c},off(e){let t=te(c).get(e);return t&&(t(),te(c).delete(e)),c},map(e,t){let r,a,s;q(e)&&(r=e,a=e.name,t=e.firstState,e=e.fn);let l=c.getState(),f=Me();f?s=null:void 0!==l&&(s=e(l,t));let i=o(s,{name:Se(c,a),config:r,strict:0}),p=Ke(c,i,'map',0,e);return X(i).before=[{type:'map',fn:e,from:n}],f&&(je(f.plain,n)||je(p.seq,f.loader)||p.seq.unshift(f.loader)),i},watch(e,t){if(!t||!g(e)){let t=Te(c,e),r=Me();return r?r.watch.push({of:n,fn:e}):e(c.getState()),t}return N(t)||S('second argument should be a function'),e.watch(e=>t(c.getState(),e))}};return c.graphite=e({scope:{state:n},node:[z.defined(),H({store:n}),z.changed({store:s}),H({store:s})],child:l,meta:Ge('store',c,r)}),He&&void 0===t&&S("current state can't be undefined, use null instead"),f&&(L(c).meta.nativeTemplate=f),ae(c,[l]),Fe(c)}function s(...e){let t,r,a;qe(e[0],(t,r)=>{a=t,e=r});let n,o,s=e[e.length-1];if(N(s)?(r=e.slice(0,-1),t=s):r=e,1===r.length){let e=r[0];k(e)||(n=e,o=1)}return o||(n=r,t&&(t=Le(t))),q(n)||S('shape should be an object'),Qe(Array.isArray(n),n,a,t)}function l(){let e={};return e.req=new Promise((t,r)=>{e.rs=t,e.rj=r}),e.req.catch(()=>{}),e}function f(t,r){let a=n(t,r),s=a.defaultConfig.handler||(()=>S("no handler used in "+a.getType()));L(a).meta.onCopy=['runner'],L(a).meta.unit=a.kind='effect',a.use=e=>(N(e)||S('.use argument should be a function'),s=e,a);let f=a.finally=Ue('finally'),i=a.done=f.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),c=a.fail=f.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),p=a.doneData=i.map({named:'doneData',fn:({result:e})=>e}),u=a.failData=c.map({named:'failData',fn:({error:e})=>e}),d=e({scope:{getHandler:a.use.getCurrent=()=>s,finally:f},node:[W({fn({params:e,req:t},{finally:r,getHandler:a},{page:n,forkPage:o}){let s,l=Ve({params:e,req:t,ok:1,anyway:r,page:n,forkPage:o}),f=Ve({params:e,req:t,ok:0,anyway:r,page:n,forkPage:o});try{s=a()(e)}catch(e){return void f(e)}q(s)&&N(s.then)?s.then(l,f):l(s)}})],meta:{op:'fx',fx:'runner',onCopy:['finally']}});L(a).scope.runner=d,L(a).seq.push(R({fn:(e,t,r)=>re(r)?{params:e,req:{rs(e){},rj(e){}}}:e}),W({fn:(e,{runner:t},{forkPage:r})=>(ve({target:t,params:e,defer:1,forkPage:r}),e.params)})),a.create=e=>{let t=l(),r={params:e,req:t};if(he){let e=he;t.req.finally(()=>{ke(e)}),ve(he.find(a),r)}else ve(a,r);return t.req};let m=a.inFlight=o(0,{named:'inFlight'}).on(a,e=>e+1).on(f,e=>e-1),h=a.pending=m.map({fn:e=>e>0,named:'pending'});return ae(a,[f,i,c,p,u,h,m,d]),a}function i(...t){let r,a,l,f,[[i,c,p],u]=Ne(t);void 0===c&&'source'in i&&('clock'in i&&null==i.clock&&S('config.clock should be defined'),c=i.clock,p=i.fn,f=i.greedy,r=i.target,a=i.name,l=i.sid,i=i.source),g(i)||(i=s(i)),void 0===c&&(c=i),a=u||a||i.shortName;let d=Me(),m=!!r;r||(k(i)&&k(c)?r=o(p?p(U(X(i)),U(X(c))):U(X(i)),{name:a,sid:l}):(r=n(a),d&&L(r).seq.push(d.loader)));let h=m&&g(r)&&L(r).meta.nativeTemplate;if(k(i)){let e=X(i);ae(i,[ze(c,r,{scope:{fn:p,targetTemplate:h},node:[d&&d.loader,!f&&I({priority:'sampler'}),M({store:e,to:p?'a':'stack'}),p&&R({fn:J}),d&&m&&d.upward],meta:{op:'sample',sample:'store'}})]),d&&(je(d.plain,e)||je(d.closure,e)||d.closure.push(e))}else{let t=G(0),a=G(),n=G();d&&d.plain.push(t,a,n),Fe(e({parent:i,node:[H({store:a}),M({from:'value',store:1,target:t})],family:{owners:[i,r,c],links:r},meta:{op:'sample',sample:'source'}})),ae(i,[ze(c,r,{scope:{fn:p,targetTemplate:h},node:[d&&d.loader,H({store:n}),M({store:t}),T({fn:e=>e}),!f&&I({priority:'sampler'}),M({store:a}),M({store:n,to:'a'}),p&&R({fn:$}),d&&m&&d.upward],meta:{op:'sample',sample:'clock'}})])}return r}function c(e){let t=Object.values(e),r={};for(let{id:e}of t)r[e]=[];for(let{id:e,before:n,after:o}of t)n&&a(n,t=>{r[t.from.id].push(e)}),o&&a(o,t=>{r[e].push(t.to.id)});return r}function p(e){if(e instanceof Map){let t={};for(let[r,a]of e)t[r.sid]=a;return t}return e}function u(e,t){function r(e){l[e]=1;let t=n[e];for(let e=0;e<t.length;e++){let a=t[e];l[a]||s[a]||r(a)}l[e]=0,s[e]=1,o.push(e)}let n={};for(let t in e)n[t]=[...new Set(e[t])];let o=[],s={},l={};for(let e in n)s[e]||l[e]||r(e);if(o.reverse(),t&&t.size>0){let e,r=[],s=[...t];for(;e=s.shift();)r.push(e),a(n[e],e=>{je(r,e)||je(s,e)||s.push(e)});a(r,e=>{Oe(o,e)})}return o}function d(e){let t=[];return function e(r){je(t,r)||(t.push(r),m(r,e))}(L(e)),t}function m({next:e,family:t,meta:r},n){'fork'!==r.unit&&'forkInFlightCounter'!==r.unit&&(a(e,n),a(t.owners,n),a(t.links,n))}Object.defineProperty(exports,'__esModule',{value:1});let h='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',g=e=>(N(e)||q(e))&&'kind'in e;const y=e=>t=>g(t)&&t.kind===e;let k=y('store'),b=y('event'),v=y('effect'),w=y('domain');var x={__proto__:null,unit:g,store:k,event:b,effect:v,domain:w};let S=e=>{throw Error(e)},q=e=>'object'==typeof e&&null!==e,N=e=>'function'==typeof e,P=e=>{q(e)||N(e)||S('expect first argument be an object')};const j=()=>{let e=0;return()=>(++e).toString(36)};let O=j(),A=j(),C=j(),D=(e,t)=>e.bind(null,t),_=(e,t,r)=>e.bind(null,t,r);const E=(e,t,r)=>({id:A(),type:e,data:r,hasRef:t});let F=0,I=({priority:e="barrier"})=>E('barrier',0,{barrierID:++F,priority:e}),M=({from:e="store",store:t,target:r,to:a=(r?'store':'stack')})=>E('mov','store'===e,{from:e,store:t,to:a,target:r}),z={defined:()=>E('check',0,{type:'defined'}),changed:({store:e})=>E('check',1,{type:'changed',store:e})},R=_(E,'compute',0),T=_(E,'filter',0),W=_(E,'run',0),H=({store:e})=>M({from:'stack',target:e});var B={__proto__:null,barrier:I,mov:M,check:z,compute:R,filter:T,run:W,update:H};let G=e=>({id:A(),current:e}),U=({current:e})=>e,$=(e,{fn:t},{a:r})=>t(e,r),J=(e,{fn:t},{a:r})=>t(r,e),K=(e,{fn:t})=>t(e),L=e=>e.graphite||e,Q=e=>e.family.owners,V=e=>e.family.links,X=e=>e.stateRef,Y=e=>e.config,Z=e=>e.ɔ,ee=e=>e.value,te=e=>e.subscribers,re=e=>e.parent,ae=(e,t)=>{let r=L(e);for(let e=0;e<t.length;e++){let a=L(t[e]);'domain'!==r.family.type&&(a.family.type='crosslink'),Q(a).push(r),V(r).push(a)}};const ne=(e=[])=>{let t=[];if(Array.isArray(e))for(let r=0;r<e.length;r++)Array.isArray(e[r])?t.push(...e[r]):t.push(e[r]);else t.push(e);return t.map(L)};let oe=({hasRef:e,type:t,data:r},a)=>{let n;e&&(n=r.store,a[n.id]=n),'mov'===t&&'store'===r.to&&(n=r.target,a[n.id]=n)},se=null;const le=(e,t)=>{if(!e)return t;if(!t)return e;let r,a=e.v.type===t.v.type;return(a&&e.v.id>t.v.id||!a&&'sampler'===e.v.type)&&(r=e,e=t,t=r),r=le(e.r,t),e.r=e.l,e.l=r,e},fe=[];let ie=0;for(;ie<5;)fe.push({first:null,last:null,size:0}),ie+=1;const ce=()=>{for(let e=0;e<5;e++){let t=fe[e];if(t.size>0){if(2===e||3===e){t.size-=1;let e=se.v;return se=le(se.l,se.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},pe=(e,t,r,a,n,o)=>ue(0,{a:null,b:null,node:r,parent:a,value:n,page:t,forkPage:o},e),ue=(e,t,r,a=0)=>{let n=de(r),o=fe[n],s={v:{idx:e,stack:t,type:r,id:a},l:0,r:0};2===n||3===n?se=le(se,s):(0===o.size?o.first=s:o.last.r=s,o.last=s),o.size+=1},de=e=>{switch(e){case'child':return 0;case'pure':return 1;case'barrier':return 2;case'sampler':return 3;case'effect':return 4;default:return-1}},me=new Set;let he,ge=0,ye=null,ke=e=>{he=e},be=e=>{ye=e},ve=(e,t,r)=>{let a=ye,n=null,o=he;if(e.target&&(t=e.params,r=e.defer,a='page'in e?e.page:a,e.stack&&(n=e.stack),o=e.forkPage||o,e=e.target),Array.isArray(e))for(let r=0;r<e.length;r++)pe('pure',a,L(e[r]),n,t[r],o);else pe('pure',a,L(e),n,t,o);r&&ge||(()=>{let e,t,r,a,n,o,s={alreadyStarted:ge,currentPage:ye,forkPage:he};ge=1;e:for(;a=ce();){let{idx:s,stack:l,type:f}=a;r=l.node,ye=n=l.page,he=l.forkPage,o=(n||r).reg;let i={fail:0,scope:r.scope};e=t=0;for(let a=s;a<r.seq.length&&!e;a++){let c=r.seq[a],p=c.data;switch(c.type){case'barrier':{let e=p.barrierID;n&&(e=`${n.fullID}_${e}`);let t=p.priority;if(a!==s||f!==t){me.has(e)||(me.add(e),ue(a,l,t,e));continue e}me.delete(e);break}case'mov':{let e;switch(p.from){case'stack':e=ee(l);break;case'a':e=l.a;break;case'b':e=l.b;break;case'value':e=p.store;break;case'store':o[p.store.id]||(l.page=n=null,o=r.reg),e=U(o[p.store.id])}switch(p.to){case'stack':l.value=e;break;case'a':l.a=e;break;case'b':l.b=e;break;case'store':o[p.target.id].current=e}break}case'check':switch(p.type){case'defined':t=void 0===ee(l);break;case'changed':t=ee(l)===U(o[p.store.id])}break;case'filter':t=!we(i,p,l);break;case'run':if(a!==s||'effect'!==f){ue(a,l,'effect');continue e}case'compute':l.value=we(i,p,l)}e=i.fail||t}if(!e)for(let e=0;e<r.next.length;e++)pe('child',n,r.next[e],l,ee(l),l.forkPage)}ge=s.alreadyStarted,ye=s.currentPage,he=s.forkPage})()};const we=(e,{fn:t},r)=>{try{return t(ee(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let xe=(e,t)=>''+e.shortName+t,Se=(e,t)=>null==t?xe(e,' → *'):t,qe=(e,t)=>{P(e),Z(e)&&t(Y(e),Z(e))},Ne=e=>{let t;return qe(e[0],(r,a)=>{t=r,e=a}),[e,t]},Pe=(e,t)=>{for(let r in e)t(e[r],r)},je=(e,t)=>e.includes(t),Oe=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)};const Ae=(e,t)=>{Oe(e.next,t),Oe(Q(e),t),Oe(V(e),t)},Ce=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=V(e);for(;a=n.pop();)Ae(a,e),(t||r&&!e.meta.sample||'crosslink'===a.family.type)&&Ce(a,t,r);for(n=Q(e);a=n.pop();)Ae(a,e),r&&'crosslink'===a.family.type&&Ce(a,t,r)},De=e=>e.clear();let _e=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),k(e))De(te(e));else if(w(e)){r=1;let t=e.history;De(t.events),De(t.effects),De(t.stores),De(t.domains)}Ce(L(e),!!t,r)},Ee=e=>{let t=_(_e,e,void 0);return t.unsubscribe=t,t},Fe=e=>(Ie&&ae(ee(Ie),[e]),e),Ie=null,Me=()=>Ie&&Ie.template,ze=(t,r,{node:a,scope:n,meta:o})=>Fe(e({node:a,parent:t,child:r,scope:n,meta:o,family:{owners:[t,r],links:r}})),Re=t=>{let r;qe(t,(e,a)=>{r=e,t=a});let{from:a,to:n,meta:o={op:'forward'}}=t;return a&&n||S('from and to fields should be defined'),r&&(o.config=r),Ee(Fe(e({parent:a,child:n,meta:o,family:{}})))},Te=(t,r)=>{if(N(r)||S('.watch argument should be a function'),he){let e=he.nodeMap[L(t).id];e&&(t=e)}return Ee(Fe(e({scope:{fn:r},node:[W({fn:K})],parent:t,meta:{op:'watch'},family:{owners:t}})))};const We=(e,t)=>(q(e)&&(We(Y(e),t),null!=e.name&&(q(e.name)?We(e.name,t):N(e.name)?t.handler=e.name:t.name=e.name),e.loc&&(t.loc=e.loc),(e.sid||null===e.sid)&&(t.sid=e.sid),e.handler&&(t.handler=e.handler),re(e)&&(t.parent=re(e)),'strict'in e&&(t.strict=e.strict),e.named&&(t.named=e.named),We(Z(e),t)),t);let He,Be=(e,t,r="event")=>{re(e)&&re(e).hooks[r](t)},Ge=(e,t,a,n)=>{let o=We({name:n,config:a},{}),s=O(),{parent:l=null,sid:f=null,strict:i=1,named:c=null}=o,p=c||o.name||('domain'===e?'':s),u=r(p,l);return t.kind=e,t.id=s,t.sid=f,t.shortName=p,t.parent=l,t.compositeName=u,t.defaultConfig=o,t.thru=e=>e(t),t.getType=()=>u.fullName,'domain'!==e&&(t.subscribe=e=>(P(e),t.watch(N(e)?e:t=>{e.next&&e.next(t)})),t[h]=()=>t),He=i,{unit:e,name:p,sid:f,named:c}},Ue=e=>n({named:e});const $e=(e,t,r,a)=>ze(e,t,{scope:{fn:a},node:[R({fn:K})],meta:{op:r}}),Je=(e,t,r,a)=>{let o;q(r)&&(o=r,r=r.fn);let s=n(xe(e,' →? *'),o);return ze(e,s,{scope:{fn:r},node:a,meta:{op:t}}),s},Ke=(e,t,r,a,n)=>{let o=X(t),s=[M({store:o,to:'a'}),R({fn:a?J:$}),z.defined(),z.changed({store:o}),H({store:o})],l=Me();if(l&&(s.unshift(l.loader),s.push(l.upward),k(e))){let t=X(e);je(l.plain,t)||(je(l.closure,t)||l.closure.push(t),o.before||(o.before=[]),o.before.push({type:'closure',of:t}))}return ze(e,t,{scope:{fn:n},node:s,meta:{op:r}})},Le=e=>t=>e(...t),Qe=(e,r,a,n)=>{let s=e?e=>e.slice():e=>Object.assign({},e),l=e?[]:{},f=Me(),i=s(l),c=G(i),p=G(1);c.type=e?'list':'shape',f&&f.plain.push(c,p);let u=o(i,{name:a||t(r)}),d=[z.defined(),M({store:c,to:'a'}),T({fn:(e,{key:t},{a:r})=>e!==r[t]}),M({store:p,to:'b'}),R({fn(e,{clone:t,key:r},a){a.b&&(a.a=t(a.a)),a.a[r]=e}}),M({from:'a',target:c}),M({from:'value',store:0,target:p}),I({priority:'barrier'}),M({from:'value',store:1,target:p}),M({store:c}),n&&R({fn:n}),z.changed({store:X(u)})],m=c.before=[];return Pe(r,(e,t)=>{if(!k(e))return void(i[t]=l[t]=e);l[t]=e.defaultState,i[t]=e.getState();let r=ze(e,u,{scope:{key:t,clone:s},node:d,meta:{op:'combine'}}),a=X(e);m.push({type:'field',field:t,from:a}),f&&(je(f.plain,a)||r.seq.unshift(f.loader))}),u.defaultShape=r,c.after=[n?{type:'map',to:X(u),fn:n}:{type:'copy',to:X(u)}],f||(u.defaultState=n?X(u).current=n(i):l),u};let Ve=({params:e,req:t,ok:r,anyway:a,page:n,forkPage:o})=>s=>ve({target:[a,Xe],params:[r?{status:'done',params:e,result:s}:{status:'fail',params:e,error:s},{fn:r?t.rs:t.rj,value:s}],defer:1,page:n,forkPage:o});const Xe=e({node:[W({fn({fn:e,value:t}){e(t)}})],meta:{op:'fx',fx:'sidechain'}}),Ye=(e,t,r)=>(e.watch(e=>{ae(r,[e]),t.add(e),e.ownerSet||(e.ownerSet=t),re(e)||(e.parent=r)}),ae(r,[e]),r=>(t.forEach(r),e.watch(r)));exports.allSettled=(e,{scope:t,params:r})=>{if(!g(e))return Promise.reject(Error('first argument should be unit'));let a=l();a.parentFork=he;let{forkInFlightCounter:n}=t.graphite.scope;n.scope.defers.push(a);let o=[t.find(e)],s=[];return v(e)?s.push({params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}):s.push(r),o.push(n),s.push(null),ve({target:o,params:s,forkPage:t}),a.req},exports.attach=e=>{let t;qe(e,(r,a)=>{t=r,e=a});let{source:r,effect:a,mapParams:n}=e;r||n||S('either `mapParams` or `source` should be defined'),n||(n=(e,t)=>t);let o,l=f(e,t),{runner:i}=L(l).scope,c=({params:e,req:t},{finally:r,effect:a},{a:o,page:s,forkPage:l})=>{let f,i=Ve({params:e,req:t,ok:0,anyway:r,page:s,forkPage:l});try{f=n(e,o)}catch(e){return i(e)}ve({target:a,params:{params:f,req:{rs:Ve({params:e,req:t,ok:1,anyway:r,page:s,forkPage:l}),rj:i}},page:s,defer:1})};if(r){let e;k(r)?e=r:(e=s(r),ae(l,[e]));let t=M({from:'store',store:X(e),to:'a'});o=[W({fn:e=>e}),t,R({fn:c})],oe(t,i.reg)}else o=[W({fn:c})];return i.scope.effect=a,i.meta.onCopy.push('effect'),i.seq.splice(0,1,...o),Be(a,l,'effect'),l},exports.clearNode=_e,exports.combine=s,exports.createApi=(...e)=>{let[[t,r],a]=Ne(e),o={};return Pe(r,(e,r)=>{let s=o[r]=n(r,{parent:re(t),config:a});t.on(s,e),Be(t,s)}),o},exports.createDomain=function t(r,a){let s=new Set,l=new Set,i=new Set,c=new Set,p=e({family:{type:'domain'}}),u={history:{domains:s,stores:l,effects:i,events:c},graphite:p};p.meta=Ge('domain',u,a,r);let[d,m,h,g]=['onEvent','onEffect','onStore','onDomain'].map(Ue);u.hooks={event:d,effect:m,store:h,domain:g},u.onCreateEvent=Ye(d,c,u),u.onCreateEffect=Ye(m,i,u),u.onCreateStore=Ye(h,l,u),u.onCreateDomain=Ye(g,s,u),u.createEvent=u.event=(e,t)=>d(n(e,{parent:u,config:t})),u.createEffect=u.effect=(e,t)=>m(f(e,{parent:u,config:t})),u.createDomain=u.domain=(e,r)=>t({name:e,parent:u,config:r}),u.createStore=u.store=(e,t)=>h(o(e,{parent:u,config:t})),Fe(u);let y=re(u);return y&&(Pe(u.hooks,(e,t)=>{Re({from:e,to:y.hooks[t]})}),y.hooks.domain(u)),u},exports.createEffect=f,exports.createEvent=n,exports.createNode=e,exports.createStore=o,exports.createStoreObject=s,exports.fork=(t,{values:r,handlers:n}={})=>{w(t)||S('first argument of fork should be domain');let o=!!r;r=p(r||{});let s=(t=>{function r(e){e=L(e);let t=n.indexOf(e);return-1===t&&S('unit not found in forked scope'),i[t]}let n=d(t),o=new Map,s=R({fn:(e,t,r)=>(ke(r.forkPage),e)}),l=e({scope:{defers:[],inFlight:0,fxID:0},node:[R({fn(e,t,r){r.parent?'finally'===r.parent.node.meta.named?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1}}),I({priority:'sampler'}),W({fn(e,t){let{inFlight:r,defers:n,fxID:o}=t;r>0||0===n.length||Promise.resolve().then(()=>{t.fxID===o&&a(n.splice(0,n.length),e=>{ke(e.parentFork),e.rs(e.value)})})}})],meta:{unit:'forkInFlightCounter'}}),f={},i=n.map(t=>{let{seq:r,next:a,meta:n,scope:o,family:s}=t,l=e({node:r.map(e=>({id:e.id,type:e.type,data:Object.assign({},e.data),hasRef:e.hasRef})),child:[...a],meta:Object.assign({forkOf:t},n),scope:Object.assign({},o)});return l.family={type:s.type,links:[...s.links],owners:[...s.owners]},f[t.id]=l,l}),c={};return a(i,e=>{let{reg:t,scope:a,meta:{onCopy:n,op:f,unit:i}}=e;for(let e in t){let r=t[e],a=o.get(r);a||(a={id:r.id,current:r.current},o.set(r,a)),c[e]=t[e]=a}if(n)for(let e=0;e<n.length;e++)a[n[e]]=r(a[n[e]]);switch(m(e,(e,t,a)=>{a[t]=r(e)}),f||i){case'store':e.meta.wrapped=(e=>({kind:'store',getState:()=>e.reg[e.scope.state.id].current,updates:{watch:D(Te,e)},graphite:e,family:e.family}))(e);break;case'event':e.seq.unshift(s);break;case'effect':e.next.push(l),e.seq.unshift(s);break;case'fx':a.finally.next.push(l),e.seq.unshift(s);break;case'watch':e.seq.unshift(s)}}),{cloneOf:t,nodeMap:f,clones:i,find:r,reg:c,getState:e=>r(e).meta.wrapped.getState(),graphite:e({family:{type:'domain',links:[l,...i]},meta:{unit:'fork'},scope:{forkInFlightCounter:l}})}})(t);if(o&&(()=>{let e=d(t),n={},o={},l=new Set,f=new Set,i=Object.getOwnPropertyNames(r);for(let{reg:t,meta:r}of e){let{nativeTemplate:e}=r;for(let r in t)n[r]=t[r],e&&f.add(r)}for(let e of s.clones){let{reg:t}=e,{unit:a,sid:n}=e.meta;if('store'===a&&n&&je(i,n)){let{state:a}=e.scope;t[a.id].current=r[n],l.add(a)}for(let e in t)o[e]=t[e]}a(u(c(n),f),e=>{((e,t)=>{let r=0;if(t&&t.before&&!l.has(e))for(let a of t.before)switch(a.type){case'map':e.current=a.fn(o[a.from.id].current);break;case'field':{let t=o[a.from.id];r||(r=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[a.field]=t.current;break}}if(!t||!t.after)return;let a=e.current;for(let e of t.after){let t=o[e.to.id];switch(e.type){case'copy':t.current=a;break;case'map':t.current=e.fn(a)}}})(o[e],n[e])})})(),n){n=p(n);let e=Object.keys(n);for(let{scope:t,meta:r}of s.clones)r.sid&&je(e,r.sid)&&(t.runner.scope.getHandler=()=>n[r.sid])}return s},exports.forward=Re,exports.fromObservable=e=>{P(e);let t=h in e?e[h]():e;t.subscribe||S('expect observable to have .subscribe');let r=n(),a=_(_e,r,void 0);return t.subscribe({next:r,error:a,complete:a}),r},exports.guard=(...t)=>{let r={op:'guard'},a='guard',[[o,l],f]=Ne(t);f&&(r.config=f,f.name&&(a=f.name)),l||(l=o,o=l.source);let{filter:c,greedy:p,name:u=a}=l,d=l.target||n(u,r.config);return g(o)||(o=s(o)),g(c)?i({source:c,clock:o,target:Fe(e({node:[T({fn:({guard:e})=>e}),R({fn:({data:e})=>e})],child:d,meta:r,family:{owners:[o,c,d],links:d}})),fn:(e,t)=>({guard:e,data:t}),greedy:p,name:u}):(N(c)||S('`filter` should be function or unit'),ze(o,d,{scope:{fn:c},node:[T({fn:K})],meta:r})),d},exports.hydrate=(e,{values:t})=>{w(e)||S('first argument of hydrate should be domain'),q(t)||S('values property should be an object');let{storeWatches:r,storeWatchesRefs:n}=(({flatGraphUnits:e,values:t,collectWatches:r})=>{let n=[],o=[],s={},l=new Set,f=Object.getOwnPropertyNames(t);for(let a of e){let{reg:e}=a,{op:i,unit:c,sid:p}=a.meta;if('store'===c&&p&&je(f,p)){let{state:e}=a.scope;e.current=t[p],l.add(e)}if(r&&'watch'===i){let e=a.family.owners[0];'store'===e.meta.unit&&(n.push(a),o.push(e.scope.state))}for(let t in e)s[t]=e[t]}return a(u(c(s)),e=>{(e=>{let t=0;if(e.before&&!l.has(e))for(let r of e.before)switch(r.type){case'map':e.current=r.fn(r.from.current);break;case'field':{let a=r.from;t||(t=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[r.field]=a.current;break}}if(!e.after)return;let r=e.current;for(let t of e.after){let e=t.to;switch(t.type){case'copy':e.current=r;break;case'map':e.current=t.fn(r)}}})(s[e])}),{storeWatches:n,storeWatchesRefs:o}})({flatGraphUnits:d(e),values:p(t),collectWatches:1});ve({target:r,params:n.map(({current:e})=>e)})},exports.is=x,exports.launch=ve,exports.merge=e=>{let r=n(t(e,'merge'));return Re({from:e,to:r,meta:{op:'merge'}}),r},exports.restore=(e,t,r)=>{if(k(e))return e;if(g(e)){let a,n=re(e);return b(e)&&(a=o(t,{parent:n,name:e.shortName,ɔ:r}).on(e,(e,t)=>t)),v(e)&&(a=o(t,{parent:n,name:e.shortName,ɔ:r}).on(e.done,(e,{result:t})=>t)),n&&n.hooks.store(a),a}let a=Array.isArray(e)?[]:{};return Pe(e,(e,t)=>{a[t]=k(e)?e:o(e,{name:t})}),a},exports.sample=i,exports.scopeBind=e=>{he||S('scopeBind cannot be called outside of forked .watch');let t=he.find(e),r=he;return e=>{ve({target:t,params:e,forkPage:r})}},exports.serialize=({clones:e,getState:t,cloneOf:r},{ignore:a=[],onlyChanges:n}={})=>{let o={};if(n){a=[...a];for(let e of r.history.stores)t(e)===e.defaultState&&a.push(e)}for(let{meta:t,scope:r,reg:a}of e){if('store'!==t.unit)continue;let{sid:e}=t;e&&(o[e]=a[r.state.id].current)}for(let{sid:e}of a)e&&delete o[e];return o},exports.setStoreName=(e,t)=>{let a=r(t,re(e));if(e.shortName=t,!e.compositeName)return void(e.compositeName=a);let n=e.compositeName;n.path=a.path,n.shortName=a.shortName,n.fullName=a.fullName},exports.split=(...e)=>{let t,[[r,a],n]=Ne(e),o=!a;o&&(t=r.cases,a=r.match,r=r.source);let s={},l=k(r)?r.updates:r;if(Pe(a,(e,t)=>{s[t]=l.filter({fn:e,config:n}),l=l.filter({fn:t=>!e(t),config:n})}),s.__=l,!o)return s;Pe(s,(e,r)=>{t[r]&&Re({from:e,to:t[r]})})},exports.step=B,exports.version="21.4.2",exports.withRegion=(e,t)=>{Ie={parent:Ie,value:e,template:L(e).meta.template||Ie&&Ie.template};try{return t()}finally{Ie=re(Ie)}};
//# sourceMappingURL=effector.cjs.js.map
